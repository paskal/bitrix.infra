#!/bin/sh
# Yandex Webmaster API - URL Reindexing Tool
#
# Usage:
#   yandex-reindex setup                - Initial setup (OAuth, host detection)
#   yandex-reindex list                 - List all verified hosts
#   yandex-reindex submit <file>        - Submit absolute URLs from file
#   yandex-reindex submit-url <url>...  - Submit one or more absolute URLs
#   yandex-reindex submit-regions <file> - Submit relative URLs for all regions
#
# Examples:
#   yandex-reindex submit-url https://example.com/page/
#   yandex-reindex submit-regions urls.txt  # file contains /catalog/section/
#
# Config: $SCRIPT_DIR/.yandex-webmaster (gitignored)
# Run 'yandex-reindex setup' to configure - it will guide you through OAuth setup.

set -eu

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/.yandex-webmaster"
API_BASE="https://api.webmaster.yandex.net/v4"

# Colours
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        . "$CONFIG_FILE"
    fi
}

save_config() {
    cat > "$CONFIG_FILE" << EOF
YANDEX_CLIENT_ID=$YANDEX_CLIENT_ID
YANDEX_OAUTH_TOKEN=$YANDEX_OAUTH_TOKEN
YANDEX_USER_ID=$YANDEX_USER_ID
YANDEX_HOST_MSK=$YANDEX_HOST_MSK
YANDEX_HOST_SPB=$YANDEX_HOST_SPB
YANDEX_HOST_TULA=$YANDEX_HOST_TULA
YANDEX_URL_MSK=$YANDEX_URL_MSK
YANDEX_URL_SPB=$YANDEX_URL_SPB
YANDEX_URL_TULA=$YANDEX_URL_TULA
EOF
    chmod 600 "$CONFIG_FILE"
    printf "${GREEN}Config saved to %s${NC}\n" "$CONFIG_FILE"
}

api_call() {
    method=$1
    endpoint=$2
    data=${3:-}

    if [ -z "${YANDEX_OAUTH_TOKEN:-}" ]; then
        printf "${RED}Error: YANDEX_OAUTH_TOKEN not set${NC}\n"
        echo "Run 'yandex-reindex setup' to configure"
        exit 1
    fi

    if [ "$method" = "GET" ]; then
        curl -s -X GET "$API_BASE$endpoint" \
            -H "Authorization: OAuth $YANDEX_OAUTH_TOKEN" \
            -H "Content-Type: application/json"
    else
        curl -s -X POST "$API_BASE$endpoint" \
            -H "Authorization: OAuth $YANDEX_OAUTH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$data"
    fi
}

cmd_setup() {
    load_config

    if [ -z "${YANDEX_OAUTH_TOKEN:-}" ]; then
        if [ -z "${YANDEX_CLIENT_ID:-}" ]; then
            printf "${YELLOW}OAuth App Setup:${NC}\n"
            echo "1. Go to https://oauth.yandex.ru/client/new"
            echo "2. Fill in app name (e.g., 'Webmaster Reindex')"
            echo "3. In 'Platforms', select 'Web services'"
            echo "4. Click 'Add URL for development' in Redirect URI"
            echo "5. In 'Access', find 'Yandex.Webmaster' and enable:"
            echo "   - webmaster:verify"
            echo "   - webmaster:hostinfo"
            echo "6. Click 'Create app'"
            echo ""
            echo "Enter your Client ID:"
            read -r YANDEX_CLIENT_ID
        fi

        echo ""
        printf "${YELLOW}Get OAuth Token:${NC}\n"
        echo "Visit this URL and click 'Allow':"
        printf "${GREEN}https://oauth.yandex.ru/authorize?response_type=token&client_id=%s${NC}\n" "$YANDEX_CLIENT_ID"
        echo ""
        echo "After redirect, copy the token from the URL and paste here:"
        read -r YANDEX_OAUTH_TOKEN
    fi

    printf "${YELLOW}Fetching user ID...${NC}\n"
    user_response=$(api_call GET "/user")
    YANDEX_USER_ID=$(echo "$user_response" | jq -r '.user_id')

    if [ "$YANDEX_USER_ID" = "null" ] || [ -z "$YANDEX_USER_ID" ]; then
        printf "${RED}Failed to get user ID. Response:${NC}\n"
        echo "$user_response"
        exit 1
    fi

    printf "${GREEN}User ID: %s${NC}\n" "$YANDEX_USER_ID"

    printf "${YELLOW}Fetching hosts...${NC}\n"
    hosts_response=$(api_call GET "/user/$YANDEX_USER_ID/hosts")

    # Parse hosts and auto-detect known ones
    echo "$hosts_response" | jq -r '.hosts[] | "\(.host_id)\t\(.ascii_host_url)"' | while IFS='	' read -r host_id host_url; do
        printf "  ${GREEN}%s${NC} -> %s\n" "$host_id" "$host_url"
    done

    # Set variables (can't use subshell, so parse again)
    YANDEX_HOST_MSK=""
    YANDEX_HOST_SPB=""
    YANDEX_HOST_TULA=""
    YANDEX_URL_MSK=""
    YANDEX_URL_SPB=""
    YANDEX_URL_TULA=""

    # Parse hosts to detect regions (MSK = main domain, SPB/TULA = subdomains)
    for line in $(echo "$hosts_response" | jq -r '.hosts[] | "\(.host_id)|\(.ascii_host_url)"'); do
        host_id=$(echo "$line" | cut -d'|' -f1)
        host_url=$(echo "$line" | cut -d'|' -f2)
        # Extract base URL (remove trailing slash if present)
        base_url=$(echo "$host_url" | sed 's|/$||')

        # Check for subdomain pattern first (more specific matches)
        if echo "$host_url" | grep -qE '://[a-z]+\.[^/]+\.[^/]+'; then
            # Has subdomain - check which region
            subdomain=$(echo "$host_url" | sed 's|.*://||; s|\..*||')
            case "$subdomain" in
                spb)
                    YANDEX_HOST_SPB="$host_id"
                    YANDEX_URL_SPB="$base_url"
                    echo "    -> Detected as SPB"
                    ;;
                tula)
                    YANDEX_HOST_TULA="$host_id"
                    YANDEX_URL_TULA="$base_url"
                    echo "    -> Detected as TULA"
                    ;;
            esac
        else
            # No subdomain or www - this is the main domain (MSK)
            # Also match www.domain as main
            if echo "$host_url" | grep -qE '://www\.'; then
                continue  # Skip www variant, prefer non-www
            fi
            YANDEX_HOST_MSK="$host_id"
            YANDEX_URL_MSK="$base_url"
            echo "    -> Detected as MSK (main)"
        fi
    done

    save_config

    echo ""
    printf "${GREEN}Setup complete!${NC}\n"
    echo "Configured regions:"
    [ -n "$YANDEX_URL_MSK" ] && echo "  MSK: $YANDEX_URL_MSK (host: $YANDEX_HOST_MSK)"
    [ -n "$YANDEX_URL_SPB" ] && echo "  SPB: $YANDEX_URL_SPB (host: $YANDEX_HOST_SPB)"
    [ -n "$YANDEX_URL_TULA" ] && echo "  TULA: $YANDEX_URL_TULA (host: $YANDEX_HOST_TULA)"
}

cmd_list() {
    load_config

    if [ -z "${YANDEX_USER_ID:-}" ]; then
        printf "${RED}Run 'yandex-reindex setup' first${NC}\n"
        exit 1
    fi

    printf "${YELLOW}Fetching hosts for user %s...${NC}\n" "$YANDEX_USER_ID"
    hosts_response=$(api_call GET "/user/$YANDEX_USER_ID/hosts")

    echo "$hosts_response" | jq -r '.hosts[] | "\(.host_id)\t\(.ascii_host_url)\t\(.main_mirror // "n/a")"' | \
        column -t -s '	'
}

get_host_id_for_url() {
    url=$1

    case "$url" in
        *"spb.favor-group.ru"*)
            echo "$YANDEX_HOST_SPB"
            ;;
        *"tula.favor-group.ru"*)
            echo "$YANDEX_HOST_TULA"
            ;;
        *)
            echo "$YANDEX_HOST_MSK"
            ;;
    esac
}

submit_url() {
    url=$1
    host_id=$(get_host_id_for_url "$url")

    if [ -z "$host_id" ]; then
        printf "${RED}No host ID found for: %s${NC}\n" "$url"
        return 1
    fi

    response=$(api_call POST "/user/$YANDEX_USER_ID/hosts/$host_id/recrawl/queue" "{\"url\": \"$url\"}")
    task_id=$(echo "$response" | jq -r '.task_id // empty')
    quota=$(echo "$response" | jq -r '.quota_remainder // empty')
    error=$(echo "$response" | jq -r '.error_code // empty')

    if [ -n "$task_id" ]; then
        printf "${GREEN}✓${NC} %s (quota: %s)\n" "$url" "$quota"
    elif [ "$error" = "URL_ALREADY_ADDED" ]; then
        printf "${YELLOW}○${NC} %s (already queued)\n" "$url"
    else
        printf "${RED}✗${NC} %s\n" "$url"
        echo "  Error: $response"
    fi
}

cmd_submit_url() {
    load_config

    if [ -z "${YANDEX_USER_ID:-}" ]; then
        printf "${RED}Run 'yandex-reindex setup' first${NC}\n"
        exit 1
    fi

    if [ $# -eq 0 ]; then
        echo "Usage: yandex-reindex submit-url <url> [<url>...]"
        exit 1
    fi

    for url in "$@"; do
        submit_url "$url"
        # Small delay between URLs to avoid rate limiting
        if [ $# -gt 1 ]; then
            sleep 0.2
        fi
    done
}

cmd_submit() {
    load_config

    if [ -z "${YANDEX_USER_ID:-}" ]; then
        printf "${RED}Run 'yandex-reindex setup' first${NC}\n"
        exit 1
    fi

    file=${1:-}
    if [ -z "$file" ] || [ ! -f "$file" ]; then
        echo "Usage: yandex-reindex submit <file_with_urls>"
        exit 1
    fi

    total=$(wc -l < "$file" | tr -d ' ')
    count=0

    printf "${YELLOW}Submitting %s URLs for reindexing...${NC}\n" "$total"
    echo ""

    while IFS= read -r url || [ -n "$url" ]; do
        # Skip empty lines and comments
        case "$url" in
            ""|\#*) continue ;;
        esac

        count=$((count + 1))
        submit_url "$url"

        # Small delay to avoid rate limiting
        sleep 0.2
    done < "$file"

    echo ""
    printf "${GREEN}Done! Submitted %s URLs.${NC}\n" "$count"
}

cmd_submit_regions() {
    load_config

    if [ -z "${YANDEX_USER_ID:-}" ]; then
        printf "${RED}Run 'yandex-reindex setup' first${NC}\n"
        exit 1
    fi

    if [ -z "${YANDEX_URL_MSK:-}" ]; then
        printf "${RED}Region URLs not configured. Run 'yandex-reindex setup' to refresh config.${NC}\n"
        exit 1
    fi

    file=${1:-}
    if [ -z "$file" ] || [ ! -f "$file" ]; then
        echo "Usage: yandex-reindex submit-regions <file_with_relative_urls>"
        echo "Will submit URLs for all configured regions (MSK, SPB, TULA)"
        echo "File must contain relative URLs starting with / (e.g., /catalog/section/)"
        exit 1
    fi

    for region in "MSK:$YANDEX_URL_MSK" "SPB:$YANDEX_URL_SPB" "TULA:$YANDEX_URL_TULA"; do
        name=$(echo "$region" | cut -d: -f1)
        base_url=$(echo "$region" | cut -d: -f2-)

        if [ -z "$base_url" ]; then
            printf "${YELLOW}Skipping %s (not configured)${NC}\n" "$name"
            continue
        fi

        printf "${YELLOW}=== Submitting for %s (%s) ===${NC}\n" "$name" "$base_url"

        while IFS= read -r url || [ -n "$url" ]; do
            case "$url" in
                ""|\#*) continue ;;
            esac

            # Only accept relative URLs
            if ! echo "$url" | grep -q '^/'; then
                printf "${RED}Skipping non-relative URL: %s${NC}\n" "$url"
                continue
            fi

            submit_url "${base_url}${url}"
            sleep 0.2
        done < "$file"

        echo ""
    done

    printf "${GREEN}Done!${NC}\n"
}

# Main
case "${1:-}" in
    setup)
        cmd_setup
        ;;
    list)
        cmd_list
        ;;
    submit)
        cmd_submit "${2:-}"
        ;;
    submit-url)
        shift
        cmd_submit_url "$@"
        ;;
    submit-regions)
        cmd_submit_regions "${2:-}"
        ;;
    *)
        echo "Yandex Webmaster API - URL Reindexing Tool"
        echo ""
        echo "Usage:"
        echo "  yandex-reindex setup                - Initial setup (OAuth, host detection)"
        echo "  yandex-reindex list                 - List all verified hosts"
        echo "  yandex-reindex submit <file>        - Submit absolute URLs from file"
        echo "  yandex-reindex submit-url <url>...  - Submit one or more absolute URLs"
        echo "  yandex-reindex submit-regions <file> - Submit relative URLs for all regions"
        echo ""
        echo "Examples:"
        echo "  yandex-reindex submit-url https://example.com/page/"
        echo "  yandex-reindex submit-regions urls.txt  # contains /catalog/section/"
        echo ""
        echo "Config: \$SCRIPT_DIR/.yandex-webmaster"
        ;;
esac
